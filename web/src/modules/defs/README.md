# –ú–æ–¥—É–ª—å Defs - –†–∞—Å—á–µ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤

## –û–ø–∏—Å–∞–Ω–∏–µ

–ú–æ–¥—É–ª—å `defs` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ. –°–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ —Å —Å–∞–π—Ç–∞ sharik.ua –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### üîÑ –†–∞—Å—á–µ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤

- –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Å–∫–ª–∞–¥—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–∞—Ö
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ Sharik
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ª–∏–º–∏—Ç–∞–º —Ç–æ–≤–∞—Ä–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î

### üíæ –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–∞ –≤ MongoDB
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏

## API Endpoints

### POST `/api/defs/calculate`

–ó–∞–ø—É—Å–∫–∞–µ—Ç —Ä—É—á–Ω–æ–π —Ä–∞—Å—á–µ—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

**–ó–∞–ø—Ä–æ—Å:**

```http
POST /api/defs/calculate

```

**–û—Ç–≤–µ—Ç –ø—Ä–∏ —É—Å–ø–µ—Ö–µ (201):**

```json
{
  "success": true,
  "message": "Deficit calculation completed and saved successfully",
  "data": {
    "total": 23,
    "totalCriticalDefs": 15,
    "totalLimitDefs": 8,
    "createdAt": "2024-01-15T10:30:00.000Z"
  }
}
```

**–û—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ (500):**

```json
{
  "success": false,
  "message": "Failed to calculate and save deficits",
  "error": "–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏"
}
```

### GET `/api/defs/latest`

–ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤.

**–ó–∞–ø—Ä–æ—Å:**

```http
GET /api/defs/latest
Authorization: Bearer <token>
```

**–û—Ç–≤–µ—Ç –ø—Ä–∏ —É—Å–ø–µ—Ö–µ (200):**

```json
{
  "success": true,
  "data": {
    "_id": "65a1b2c3d4e5f6789012345",
    "result": {
      "1102-3101": {
        "nameukr": "1102-3101 –ö—É–ª—å–∫–∞ –Ü 12\"/01 –ü–∞—Å—Ç–µ–ª—å –±—ñ–ª–∏–π \"–ú–ê–ö–°–Ü\",500–æ–¥",
        "quant": 115000,
        "sharikQuant": 49500,
        "difQuant": -65500,
        "defLimit": 115500
      }
    },
    "total": 1,
    "totalCriticalDefs": 1,
    "totalLimitDefs": 0,
    "createdAt": "2024-01-15T10:30:00.000Z",
    "updatedAt": "2024-01-15T10:30:00.000Z"
  }
}
```

**–û—Ç–≤–µ—Ç –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö (404):**

```json
{
  "success": false,
  "message": "No deficit calculations found"
}
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### IDeficitItem

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ñ–∏—Ü–∏—Ç–µ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É:

```typescript
interface IDeficitItem {
  nameukr: string; // –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —É–∫—Ä–∞–∏–Ω—Å–∫–æ–º
  quant: number; // –¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ
  sharikQuant: number; // –û—Å—Ç–∞—Ç–æ–∫ –ø–æ –¥–∞–Ω–Ω—ã–º Sharik
  difQuant: number; // –†–∞–∑–Ω–∏—Ü–∞ (sharikQuant - quant)
  defLimit: number; // –°—É–º–º–∞ –ª–∏–º–∏—Ç–∞ –∞—Ä—Ç–∏–∫—É–ª–∞ –∏ quant
}
```

### IDefcalc

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤:

```typescript
interface IDefcalc {
  result: IDeficitCalculationResult; // –û–±—ä–µ–∫—Ç —Å –¥–µ—Ñ–∏—Ü–∏—Ç–∞–º–∏ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º
  total: number; // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤
  totalCriticalDefs: number; // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ—Ñ–∏—Ü–∏—Ç—ã (sharikQuant <= quant)
  totalLimitDefs: number; // –î–µ—Ñ–∏—Ü–∏—Ç—ã –≤ –ª–∏–º–∏—Ç–µ (sharikQuant <= defLimit –Ω–æ > quant)
  createdAt: Date; // –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
  updatedAt: Date; // –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
}
```

## –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤

–°–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –ø–æ —Å–ª–µ–¥—É—é—â–∏–º —É—Å–ª–æ–≤–∏—è–º:

1. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–µ—Ñ–∏—Ü–∏—Ç** - `sharikQuant <= quant` (–æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∞–π—Ç–µ –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–µ–Ω –æ—Å—Ç–∞—Ç–∫—É –Ω–∞ —Å–∫–ª–∞–¥–µ)
2. **–î–µ—Ñ–∏—Ü–∏—Ç –≤ –ª–∏–º–∏—Ç–µ** - `sharikQuant <= defLimit` –Ω–æ `sharikQuant > quant` (–æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∞–π—Ç–µ –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞, –Ω–æ –±–æ–ª—å—à–µ –æ—Å—Ç–∞—Ç–∫–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ)
3. **`defLimit`** - —Å—É–º–º–∞ –ª–∏–º–∏—Ç–∞ –∞—Ä—Ç–∏–∫—É–ª–∞ –∏ `quant` (–∫–æ–≥–¥–∞ `sharikQuant` –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ, –¥–µ—Ñ–∏—Ü–∏—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤ –ª–∏–º–∏—Ç–µ)

### ‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞

```
‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤

–û—à–∏–±–∫–∞: –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏

### –ú–æ–¥—É–ª—å Arts

- –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ (`getArtLimits`)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ–± –∞—Ä—Ç–∏–∫—É–ª–∞—Ö

### –ú–æ–¥—É–ª—å Poses

- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∫–ª–∞–¥—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ (`getPogrebiDefStocks`)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ Sharik (`getSharikStocks`)

### –ú–æ–¥—É–ª—å Comps

- –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–∞–π—Ç–∞ sharik.ua (`getSharikData`)

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤

```typescript
const response = await fetch("/api/defs/latest", {
  headers: {
    Authorization: `Bearer ${token}`,
  },
});

const { success, data } = await response.json();

if (success && data) {
  const deficits = Object.entries(data.result).map(([artikul, item]) => ({
    artikul,
    name: item.nameukr,
    currentStock: item.quant,
    requiredStock: item.sharikQuant,
    deficit: Math.abs(item.difQuant),
    defLimit: item.defLimit,
    isCritical: item.sharikQuant <= item.quant,
    isInLimit:
      item.sharikQuant <= item.defLimit && item.sharikQuant > item.quant,
  }));
}
```

### –ó–∞–ø—É—Å–∫ —Ä—É—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞

```typescript
const response = await fetch("/api/defs/calculate", {
  method: "POST",
  headers: {
    Authorization: `Bearer ${token}`,
    "Content-Type": "application/json",
  },
});

const result = await response.json();
console.log(`–ù–∞–π–¥–µ–Ω–æ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤: ${result.data.total}`);
console.log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö: ${result.data.totalCriticalDefs}`);
console.log(`–í –ª–∏–º–∏—Ç–µ: ${result.data.totalLimitDefs}`);
```

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

```typescript
// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –¥–µ—Ñ–∏—Ü–∏—Ç–∞–º
const getDeficitStats = (data: IDefcalc) => {
  return {
    total: data.total,
    deficits: data.total,
    critical: data.totalCriticalDefs,
    nearLimit: data.totalLimitDefs,
  };
};
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–í—Å–µ endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –ø–æ–ª—è–º–∏:

- `success: boolean` - —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- `message: string` - –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- `data?: any` - –¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞ (–ø—Ä–∏ —É—Å–ø–µ—Ö–µ)
- `error?: string` - –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ (–ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ)

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ endpoints —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (JWT —Ç–æ–∫–µ–Ω)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π —á–µ—Ä–µ–∑ Mongoose ODM

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ó–∞–¥–µ—Ä–∂–∫–∞ 100ms –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∫ Sharik –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–∞–∂–¥—ã–µ 10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ Mongoose middleware
